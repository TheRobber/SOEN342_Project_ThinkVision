<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Train Search</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      color: #333;
      margin: 0;
      padding: 20px;
    }


    .container {
      max-width: 800px;
      margin: 0 auto;
    }


    header {
      text-align: center;
      margin-bottom: 20px;
    }


    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }


    input, select, button {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }


    button {
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }


    button.secondary {
      background-color: #777;
    }


    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }


    .results {
      margin-top: 20px;
    }


    .card {
      background: white;
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      background-color: #fff;
    }


    .card .route {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 8px;
    }


    .card .info {
      margin-bottom: 10px;
    }


    .card .info div {
      margin-bottom: 5px;
    }


    .card .price {
      font-weight: bold;
      color: #4CAF50;
      margin-top: 10px;
    }


    .card .price strong {
      font-size: 16px;
    }


    .empty {
      text-align: center;
      color: #777;
      padding: 20px 10px;
    }


    table.seg-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 10px;
    }


    table.seg-table th,
    table.seg-table td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }


    tr.layover td {
      background: #fafafa;
      font-style: italic;
      color: #555;
    }


    /* Booking form styling inside card */
    .booking-section {
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }


    .booking-passenger-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      background: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
    }


    .booking-passenger-row input {
      flex: 1 1 120px;
    }


    .booking-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }


    .small-note {
      font-size: 12px;
      color: #555;
    }


    
    .trip-card {
      background: white;
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
    }


    .trip-header {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 15px;
    }


    .ticket-line {
      font-size: 13px;
      margin-bottom: 4px;
    }


    .muted {
      color: #777;
      font-size: 13px;
    }


    .panel {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 20px;
      padding: 15px;
    }


    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
    }


    .panel-title {
      font-size: 16px;
      font-weight: bold;
    }


    .panel-body .error {
      color: #c00;
      background: #fee;
      border: 1px solid #c99;
      padding: 8px;
      border-radius: 4px;
      font-size: 13px;
      margin-bottom: 10px;
    }

    @media (max-width: 600px) {
      form {
        width: 100%;
      }
      input, select, button {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="muted" id="status">Think Vision Train Connection Services</div>
    </header>


    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Search</div>
        <div class="muted" id="count">0 itineraries</div>
      </div>
      <div class="panel-body">
        <div id="msg" class="error" style="display:none;"></div>
        <form id="searchForm" class="grid">
          <div class="field span-4">
            <label for="from">From</label>
            <input id="from" name="from" type="text" placeholder="e.g., Paris" />
          </div>
          <div class="field span-4">
            <label for="to">To</label>
            <input id="to" name="to" type="text" placeholder="e.g., Berlin" />
          </div>
          <div class="field span-2">
            <label for="day">Day</label>
            <select id="day" name="day">
              <option value="">Any</option>
              <option>MON</option><option>TUE</option><option>WED</option>
              <option>THU</option><option>FRI</option><option>SAT</option><option>SUN</option>
            </select>
          </div>
          <div class="field span-2">
            <label for="sort">Sort by</label>
            <select id="sort" name="sort">
              <option value="duration">Shortest duration</option>
              <option value="price">Lowest 2nd class price</option>
              <option value="depart">Earliest departure</option>
            </select>
          </div>
          <div class="field span-12">
            <button id="searchButton" type="submit">Search</button>
            <button id="resetButton" type="button" class="secondary" style="margin-left:8px;">Reset</button>
          </div>
        </form>
      </div>
    </section>


    
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Results</div>
      </div>
      <div class="panel-body">
        <div id="results" class="results">
          <div class="empty">Enter a query and press Search.</div>
        </div>
      </div>
    </section>


    
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">View My Trips</div>
        <div class="muted small-note">View current & past trips</div>
      </div>
      <div class="panel-body">
        <div id="tripMsg" class="error" style="display:none;"></div>
        <form id="tripsForm">
          <div class="field span-6">
            <label for="tripLastName">Last Name</label>
            <input id="tripLastName" type="text" placeholder="e.g., Smith" />
          </div>
          <div class="field span-6">
            <label for="tripIdNumber">ID Number</label>
            <input id="tripIdNumber" type="text" placeholder="e.g., A1234567" />
          </div>
          <div class="field span-12" style="margin-top:10px;">
            <button id="tripsButton" type="submit">Find My Trips</button>
          </div>
        </form>


        <div id="tripsResults" class="results" style="margin-top:20px;">
          <div class="empty">No trips loaded.</div>
        </div>
      </div>
    </section>
  </div>



  <script>

    const API_BASE = "http://localhost:3001";


    const $ = (sel) => document.querySelector(sel);


    const minutesToTime = (mins) => {
      mins = Math.max(0, Number(mins) || 0);
      const hours = Math.floor(mins / 60);
      const minutes = mins % 60;
      return `${hours}hours ${String(minutes).padStart(2, "0")}minutes`;
    };


    function formatLayover(mins) {
      mins = Math.max(0, Number(mins) || 0);
      const hours = Math.floor(mins / 60);
      const minutes = mins % 60;
      return `${hours}hours ${String(minutes).padStart(2, "0")}minutes`;
    }


    const stopsLabel = (segments) => {
      const totalStops = (segments?.length || 1) - 1;
      if (totalStops <= 0) return "Direct";
      if (totalStops === 1) return "1 stop";
      return `${totalStops} stops`;
    };


    function renderResults(itins) {
      const results = $("#results");
      const countEl = $("#count");
      results.innerHTML = "";


      if (!Array.isArray(itins) || itins.length === 0) {
        results.innerHTML = '<div class="empty">No results found.</div>';
        countEl.textContent = "0 itineraries";
        return;
      }


      countEl.textContent = `${itins.length} itinerar${itins.length > 1 ? "ies" : "y"}`;


      itins.forEach((it) => {
        const segs = it.segments || [];
        const first = segs[0] || {};
        const last  = segs[segs.length - 1] || {};
        const layovers = (it.transferTimes || []).map((t) => `${t}minutes`).join(", ") || "—";


        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-head">
            <div class="route">${first.from || "?"} → ${last.arriveCity || "?"}</div>
            <div class="total">
              <div>Duration: <strong>${minutesToTime(it.totalDurationMinutes)}</strong></div>
              <div>${stopsLabel(segs)}</div>
              <div>Layovers: <strong>${layovers}</strong></div>
              <div>2nd class total: <span class="price">€${(it.totalPrice?.second ?? 0)}</span></div>
              <div>1st class total: <span class="price-1st">€${(it.totalPrice?.first ?? 0)}</span></div>
            </div>
          </div>
          <div class="panel-body">
            <table class="seg-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Route ID</th>
                  <th>From</th>
                  <th>To</th>
                  <th>Depart</th>
                  <th>Arrive</th>
                  <th>Type</th>
                  <th>1st (€)</th>
                  <th>2nd (€)</th>
                </tr>
              </thead>
              <tbody>
                ${segs.map((segment, index) => `
                  <tr>
                    <td>${index + 1}</td>
                    <td>${segment.routeId ?? ""}</td>
                    <td>${segment.from ?? ""}</td>
                    <td>${segment.arriveCity ?? ""}</td>
                    <td>${segment.departTime ?? ""}</td>
                    <td>${segment.arriveTime ?? ""}</td>
                    <td>${segment.trainType ?? ""}</td>
                    <td>${segment.price?.first ?? ""}</td>
                    <td>${segment.price?.second ?? ""}</td>
                  </tr>
                  ${
                    index < segs.length - 1
                      ? `<tr class="layover"><td colspan="9">Time to change connection at <strong>${segment.arriveCity ?? "transfer"}</strong>: ${formatLayover(it.transferTimes?.[index])}</td></tr>`
                      : ""
                  }
                `).join("")}
              </tbody>
            </table>
          </div>
        `;
        results.appendChild(card);
      });
    }


    async function doSearch(params) {
      const msg = $("#msg");
      const status = $("#status");
      msg.style.display = "none";
      status.textContent = "Searching…";
      try {
        const queryString = new URLSearchParams(params);
        const response = await fetch(`${API_BASE}/api/search?${queryString.toString()}`, { headers: { "Accept": "application/json" } });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        status.textContent = `Found ${data.itineraries?.length ?? 0} result(s)`;
        return data;
      } catch (err) {
        status.textContent = "Search failed";
        msg.textContent = `Error: ${err.message || err}`;
        msg.style.display = "block";
        return { itineraries: [] };
      }
    }


    $("#searchForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const from = $("#from").value.trim();
      const to   = $("#to").value.trim();
      const day  = $("#day").value;            // "" (Any) or MON..SUN
      const sort = $("#sort").value || "duration";


      const msg = $("#msg");
      msg.style.display = "none";


      if (!from || !to) {
        msg.textContent = "Please enter both 'From' and 'To' cities.";
        msg.style.display = "block";
        return;
      }


      $("#searchButton").disabled = true;
      const { itineraries, error } = await doSearch({ from, to, day, sort, class: "second" });
      $("#searchButton").disabled = false;


      if (error) {
        msg.textContent = error;
        msg.style.display = "block";
      }
      renderResults(itineraries || []);
    });


    $("#resetButton").addEventListener("click", () => {
      $("#searchForm").reset();
      $("#status").textContent = "Think Vision Train Connection Services";
      $("#count").textContent = "0 itineraries";
      $("#results").innerHTML = '<div class="empty">Enter a query and press Search.</div>';
      $("#msg").style.display = "none";
    });
  </script>
</body>
</html>